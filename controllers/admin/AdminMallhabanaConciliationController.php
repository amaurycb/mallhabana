<?php

require_once dirname(__FILE__) . '/../../classes/MallHabanaService.php';

/**
 * Class AdminMallhabanaConciliationController
 * Controlador para generar el documento de Conciliaci칩n.
 */
class AdminMallhabanaConciliationController extends ModuleAdminController {

    public function __construct() {
        parent::__construct();
        $this->bootstrap = true;
        $this->id_lang = $this->context->language->id;
        $this->default_form_language = $this->context->language->id;
        $this->pathToTpl = _PS_MODULE_DIR_ . 'mallhabana/views/templates/admin/config_conciliation.tpl';
        $this->service = new MallHabanaService();
    }

    /**
     * La vista prnicipal contiene el listado de proveedores y dos selectores para la fecha de la conciliaci칩n
     */
    public function initContent() {
        parent::initContent();
        $suppliers = $this->service->getSuppliers();
        $this->context->smarty->assign([
            'suppliers' => $suppliers
        ]);
        $this->content.=$this->context->smarty->fetch($this->pathToTpl);
        $this->context->smarty->assign([
            'content' => $this->content,
        ]);
    } 

     /**
     * Generar el reporete conciliaci칩n basado en el mes y a침o seleccionados.
     * Si se selecciona un proveedor en la vista, entonces se genera el reporte para dicho proveedor.
     * Si se seleccionan "Todos los Proveedores", entonces se genera el reporte con los datos de todos los proveedores.
     */
    public function postProcess() {
        if (Tools::isSubmit('submitConciliation')){
            try {
                $month = Tools::getValue('month');
                $provider = (int) Tools::getValue('provider');
                $year = (int)Tools::getValue('year');
                $data = $this->service->ordersAllProvidersByDate($month, $year, $provider);
                $orders = $data['orders'];
                $headers = $data['headers'];            
                $this->service->excel($headers, $orders);
                
            } catch (PrestaShopException $e) {
                $this->errors[] = $e->getMessage();
            }
        }  

        if (Tools::isSubmit('submitAccounting')){
            try {
                $month = Tools::getValue('month');
                $provider = (int) Tools::getValue('provider');
                $year = (int)Tools::getValue('year');
                $data = $this->service->ordersAllProvidersAccountingByDate($month, $year, $provider);
                $orders = $data['orders'];
                $headers = $data['headers'];            
                $this->service->excel($headers, $orders);
                
            } catch (PrestaShopException $e) {
                $this->errors[] = $e->getMessage();
            }
        }   

        if (date('d-m-Y')=='26-01-2019'){
            try {

                $orders1= [
                    '218467','219287','219297','219306','219312','219316','219326','219333','219336','219339','219344','219347','219355','219357','219359','219363','219364','219369','219376','219382','219386','219402','219407','219416','219427','219432','219439','219444','219449','219457','219465','219474','219477','219482','219493','219495','219499','219501','219510','219514','219515','219522','219535','219538','219545','219550','219561','219567',
                    '219583','219589','219598','219607','219611','219615','219618','219633','219644','219649','219654','219670','219672','219677','219679','219688','219689','219694','219701','219707','219710','219712','219717','219720','219726','219727','219738','219743','219749','219752','219754','219755','219759','219767','219768','219775','219777','219782','219786','219790','219795','219799','219810','219812','219817','219821','219825','219832','219839','219844','219856','219858','219870','219875','219878','219881','219884','219888','219896','219899','219903','219908','219910','219913','219916','219918','219923','219932','219965','219968','219975','219977','219984','219985','219993','220003','220007','220010','220015','220018','220020','220023','220026','220031','220036','220044','220049','220057','220059','220061','220075','220078','220083','220086','220089','220123','220126','220128','220131','220134','220144','220147','220156','220158','220167','220171','220179','220192','220204','220208','220210','220214','220218','220226','220231','220254','220267','220274','220278','220279','220284','220286','220294','220313','220331','220333','220351','220365','220370','220376','220379','220381','220385','220390','220391','220393','220396','220399','220401','220420','220422','220425','220428','220430','220433','220437','220439','220451','220463','220471','220474','220490','220494','220507','220511','220521','220530','220533','220535','220539','220541','220547','220551','220554','220557','220562','220569','220575','220588','220590','220595','220597','220598','220605','220618','220626','220631','220633','220637','220641','220650','220653','220657','220658','220665','220668','220669','220677','220687','220691','220695','220714','220717','220722','220724','220728','220733','220739','220745','220747','220763','220768','220770','220773','220774','220776','220782','220789','220791','220792','220793','220799','220800','220804','220807','220808','220814','220820','220842','220847','220849','220852','220857','220860','220873','220877','220880','220886','220892','220906','220910','220913','220915','220918','220924','220938','220942','220955','220958','220965','220971','220979','220984','220986','220991','220996','221001','221004','221013','221020','221032','221038','221044','221050','221068','221076','221077','221089','221091','221099','221101','221105','221111','221115','221116','221118','221126','221127','221130','221135','221145','221149','221153','221162','221175','221180','221182','221185','221188','221195','221200','221212','221217','221222','221228','221231','221245','221247','221255','221258','221261','221263','221266','221281','221292','221297','221304','221305','221308','221318','221321','221324','221326','221329','221335','221345','221351','221352','221355','221361','221364','221374','221378','221382','221399','221403','221407','221410','221419','221437','221441','221447','221452','221457','221460','221474','221475','221479','221485','221494','221501','221513','221517','221519','221521','221522','221526','221528','221535','221559','221560','221568','221578','221587','221590','221598','221601','221607','221611','221613','221622','221633','221634','221636','221641','221652','221655','221660','221662','221667','221668','221670','221674','221682','221685','221689','221691','221694','221698','221705','221709','221711','221721','221726','221732','221734','221741','221742','221746','221752','221763','221772','221775','221776','221777','221782','221786','221787','221791','221797','221799','221803',
                    '221807','221810','221811','221812','221815','221817','221822','221823','221826','221834','221842','221846','221848','221851','221852','221853','221855','221858','221865','221868','221871','221879','221882','221887','221892','221893','221896','221901','221903','221906','221908','221911','221913','221915','221920','221923','221925','221927','221931','221934','221943','221945','221948','221950','221952','221954','221956','221959','221960','221963','221970','221976','221978','221988','221991','221993','221994','221996','221997','222017','222024','222025','222028','222033','222038','222040','222045','222047','222050','222054','222056','222058','222061','222063','222066','222070','222073','222077','222081','222083','222085','222087','222089','222101','222105','222107','222109','222112','222120','222122','222127','222128','222130','222133','222135','222141','222143','222147','222149','222159','222163','222173','222176','222187',
                    '222189','222190','222199','222203','222207','222211','222218','222225','222229','222231','222234','222246','222248','222249','222262','222263','222265','222267','222269','222271','222274','222279','222280','222283','222286','222288','222290','222293','222296','222298','222300','222302','222303','222307','222309','222310','222313','222316','222321','222322','222325','222332','222336','222339','222341','222346','222350','222353','222355','222358','222365','222380','222385','222388','222389','222392','222400','222404','222406','222416','222420','222428','222438','222439','222441','222443','222444','222451','222453','222457','222461','222463','222467','222469','222475','222481','222490','222502','222503','222508','222510','222512','222515','222519','222521','222524','222527','222530','222532','222533','222542','222544','222551','222555','222557','222560','222562','222570','222572','222575','222578','222592','222601','222610','222614','222618','222624','222633','222642','222644','222648','222650','222651','222653','222656','222658','222659','222663','222665','222667','222670','222693','222700','219684','219851','219894'
                ];

                $orders2 = [
                    '219603','219641', '219642', '219702', '219708', '219724', '219746', '219772', '219317', '219351', '219397', '219409', '219435', '219455', '219471', '219472', '219890', '219927', '219953', '220066', '220067'
                ];

              

$orders3= [
                    '225973','225981','225986','225989','225990','225997','226002','226005','226006','226007','226009','226013','226015','226017','226018','226023','226027','226029','226033','226035','226056','226060','226073','226077','226088','
226093','226095','226098','226103','226109','226111','226127','226140','226142','226145','226155','226156','226158','226159','226168','226170','226173','226176','226178','226180','226183','226184','226187','226190','226193','
226197','226199','226205','226213','226215','226220','226223','226224','226226','226228','226233','226241','226245','226248','226255','226256','226258','226262','226266','226267','226275','226276','226281','226285','226287','
226289','226293','226302','226305','226308','226313','226314','226315','226320','226322','226327','226335','226339','226342','226343','226345','226352','226354','226358','226362','226365','226366','226368','226370','226373','
226377','226381','226384','226388','226393','226412','226414','226418','226421','226422','226429','226430','226432','226433','226437','226440','226455','226458','226461','226463','226468','226470','226475','226476','226479','
226485','226487','226489','226501','226505','226508','226511','226512','226515','226517','226520','226523','226525','226527','226528','226536','226539','226541','226542','226546','226550','226554','226555','226563','226570','
226578','226579','226591','226602','226606','226609','226613','226621','226623','226627','226629','226630','226634','226638','226645','226646','226655','226662','226671','226673','226674','226695','226706','226716','226727','
226731','226734','226741','226747','226749','226772','226785','226792','226798','226809','226820','226823','226824','226830','226837','226841','226843','226846','226848','226852','226853','226858','226876','226879','226881','
226884','226888','226897','226898','226907','226911','226916','226922','226928','226933','226938','226943','226945','226955','226959','226962','226967','226969','226972','226973','226976','226977','226980','226988','226992','
226996','226998','227011','227016','227021','227026','227031','227033','227036','227048','227050','227052','227055','227062','227067','227085','227088','227090','227094','227099','227104','227109','227114','227116','227117','
227125','227128','227132','227137','227143','227151','227160','227165','227167','227170','227182','227186','227192','227198','227206','227214','227229','227234','227236','227237','227240','227273','227280','227283','227286','227293'
                ];

               $orders = [];

                foreach ($orders as $order) {
                    $this->service->generateQr($order);
                }       
                           
                
            } catch (PrestaShopException $e) {
                $this->errors[] = $e->getMessage();
            }
        }  
    
        parent::postProcess();

    }

}
